---
title: "Debianï¼ˆWSL2ï¼‰+Docker+PhpStormã®ç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸŒ€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["WSL","Debian","Docker","PhpStorm"]
published: true
---
WSL 2ä¸Šã«Debianã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸéš›ã®æ·¡ã€…ã¨ã—ãŸè¨˜éŒ²ã§ã™ã€‚

(è¿½è¨˜ï¼š2022/03/06)
ã ã£ãŸã‘ã©ã€è¨˜äº‹ã®å¤§å‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å®Ÿæ–½ã€‚  
Dockerã‚’WSLã¸è¨­å®šã—ã€PhpStormã‹ã‚‰tcpæ¥ç¶šã™ã‚‹ãŸã‚ã®è¨˜äº‹ã§ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
sudo apt update && sudo apt dist-upgrade
sudo apt install wget curl make git vim
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.profile
curl https://get.volta.sh | bash
source ~/.profile
brew install tfenv
tfenv install latest
tfenv use latest
volta install node@lts
volta install pnpm
sudo echo "VOLTA_FEATURE_PNPM=1" >> .profile
source ~/.profile
```

## Docker Desktop for Windowsã¨ã®é€£æº
1. Settings | Resources | WSL INTEGRATION
2. Enable integration with additional distros: ã§ä½¿ã„ãŸã„ãƒ‡ã‚£ã‚¹ãƒˆãƒ­ã‚’ON

ä¸€ç•ªã‚„ã‚ŠãŸã‹ã£ãŸDocker Desktop for Windowsã‚’ä½¿ã£ãŸWSLä¸Šã§ã®å‘¼ã³å‡ºã—ã€‚

ãƒ‡ã‚£ã‚¹ãƒˆãƒ­ãŒ1ã¤ã—ã‹å…¥ã£ã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ã‚£ã‚¹ãƒˆãƒ­ã«ã¯è‡ªå‹•ã§WSLã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒç™ºå‹•ã™ã‚‹ã€‚

ã—ã‹ã—ã€2ã¤ä»¥ä¸Šã®å ´åˆã¯ã€æŒ‡å®šã—ã¦ONã«ã—ãªã„ã¨Docker Desktopã¨ã®é€£æºãŒå–ã‚Œãªã„ã€‚

ã“ã®è¨­å®šã‚’ã™ã‚Œã°WSL2ä¸Šã§ `docker` ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚


## Docker on WSL2
Docker DesktopãŒæœ‰æ–™åŒ–ã—ãŸã“ã¨ã‚’å—ã‘ã€Dockerã‚’WSL2ã®Debianã¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

https://docs.docker.com/engine/install/debian/

ã¾ãšã¯å…¬å¼é€šã‚Šã«ã€‚Docker Composeã¯[ã“ã¡ã‚‰](http://docs.docker.jp/compose/install.html#linux)ã‹ã‚‰ã€‚ãã—ã¦ã€ãã®ã¾ã¾ã§ã¯ `docker run` ã§ããªã„ã€‚WSL2å´ã§å‹•ä½œã—ãªã„ã®ã§ã€è¿½åŠ ã§ä¸‹è¨˜ä½œæ¥­ã™ã‚‹ã€‚

```bash
$ sudo touch /etc/fstab
$ sudo update-alternatives --set iptables /usr/sbin/iptables-legacy
$ sudo service docker start
```

## Docker Composeã‚’åˆ¥é€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
Compose V2ã«ãªã‚‹ã¨ã€Composeè‡ªä½“ãŒãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦åˆ†é›¢ã—ã¦ã„ã‚‹ã®ã§åˆ¥é€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

https://docs.docker.com/compose/cli-command/#install-on-linux

```bash
$ DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
$ mkdir -p $DOCKER_CONFIG/cli-plugins
$ curl -SL https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
$ chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
```


## Docker on WSL2ã¨PhpStormã‚’æ¥ç¶šã™ã‚‹
### SSHæ¥ç¶š
ã¾ãšã¯æ‰‹è»½ã«SSHã§æ¥ç¶šæ–¹å¼ã€‚

```bash
$ sudo apt install openss-server
$ sudo vim /etc/ssh/sshd_config
# é©å½“ã«ãƒãƒ¼ãƒˆã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’å¤‰ãˆã‚‹
$ sudo service ssh start
```
ã¨ã‚Šã‚ã‘æ¥ç¶šãŒé…ã„ãªã©ã¯æ„Ÿã˜ã‚‰ã‚Œãªã„ã®ã§å¤§ä¸ˆå¤«ãã†ã€‚

ã‚ã¨ã¯PhpStormã® `File | Settings | Build, Execution, Deployment | Docker` ã‹ã‚‰Dockerã¸ã®æ¥ç¶šã«SSHã‚’é¸æŠã€‚

### TCPæ¥ç¶š
æ±ç”¨çš„ãªæ¥ç¶šæ–¹æ³•ã¨ã—ã¦ã¯ã“ã¡ã‚‰ã£ã½ã„ã€‚
ã‚µãƒ¼ãƒãƒ¼å†…ã®è¨­å®šã‚’ã„ã‚ã„ã‚ã¨å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ã‚ã‚‹ã€‚
```bash
$ mkdir /etc/systemd/system/docker.service.d
$ sudo vim /etc/systemd/system/docker.service.d/override.conf
```
```ini
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
```
```bash
$ sudo vim /etc/docker/daemon.json
```
```json
{"hosts": ["tcp://127.0.0.1:2375", "unix:///var/run/docker.sock"]}
```
```bash
$ sudo service docker restart
```
â€»2375ã¯ãƒãƒ¼ãƒˆç•ªå·ãªã®ã§ã€ã‚‚ã¡ã‚ã‚“å¥½ããªã‚ˆã†ã«å¤‰æ›´å¯èƒ½

https://www.jetbrains.com/help/phpstorm/docker.html

æœ€å¾Œã«ã€PhpStormã® `File | Settings | Build, Execution, Deployment | Docker` ã‹ã‚‰ `TCP Socker` ã‚’é¸æŠã€‚  
`Engine API URL` ã« `http://localhost:2375` ã‚’è¨­å®šã€‚

#### PhpStormã®run/debugã§ã®docker-composeã®tcpæ¥ç¶š
Run/Debugã‹ã‚‰Docker Composeã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€tcpæ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚
æ–¹æ³•ã¯äºŒé€šã‚Šã€‚

- .envã‚’ä½¿ç”¨
- run/debugã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
- OSã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

##### .envã‚’ä½¿ç”¨
1. .envã¯docker-compose.ymlã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼éšå±¤ã«è¨­ç½®ã€‚
2. .envã«ä¸‹è¨˜äºŒè¡Œã‚’è¿½åŠ 
    ```bash
    DOCKER_HOST=tcp://localhost:2375
    COMPOSE_CONVERT_WINDOWS_PATHS=1
    ```
    - [DOCKER_HOST](https://matsuand.github.io/docs.docker.jp.onthefly/compose/reference/envvars/#docker_host): Dockerã®ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã®æ¥ç¶šå…ˆURL
    - [COMPOSE_CONVERT_WINDOWS_PATHS](https://matsuand.github.io/docs.docker.jp.onthefly/compose/reference/envvars/#compose_convert_windows_paths): Windowsã®ãƒ‘ã‚¹ã‚’Unixãƒ‘ã‚¹ã¸å¤‰æ›ã™ã‚‹ã€‚
    
   DOCKER_HOSTã¯å¿…é ˆã ãŒã€ãã®ä»–ã®ç’°å¢ƒå¤‰æ•°ã¯å¿…è¦ã«å¿œã˜ã¦ã€‚

ãŸã ã€Docker on WSL + tcpæ¥ç¶š + PhpStormã®çµ„ã¿åˆã‚ã›ã ã¨ã†ã¾ãå‹•ã‹ãªã„ã®ã§ã€ãã®å ´åˆ2.ã®æ–¹ãŒç¢ºå®Ÿã€‚

##### Run/Debugã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 

https://www.jetbrains.com/help/phpstorm/docker.html

1. `Run/Debug Configurations` ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
2. Dockerã®è¨­å®šã‚’é¸æŠ
3. `Modify options` ã‹ã‚‰ `Environment variables` ã‚’é¸æŠ
4. Environment variablesã®æ ã«ä¸‹è¨˜ã‚’å…¥åŠ›
    ```bash
    DOCKER_HOST=tcp://localhost:2375;COMPOSE_CONVERT_WINDOWS_PATHS=1
    ```
   DOCKER_HOSTã¯å¿…é ˆã ãŒã€ãã®ä»–ã®ç’°å¢ƒå¤‰æ•°ã¯å¿…è¦ã«å¿œã˜ã¦ã€‚
5. OK

## ä»¥ä¸Š
ä»Šå¾Œã¾ãŸä½•ã‹ã‚ã‚Œã°éšæ™‚æ›´æ–°äºˆå®šã€‚
